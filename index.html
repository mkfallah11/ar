<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>AR Multi Markers</title>
  <style>
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071124,#0f1724);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    #app{height:100%;display:flex;flex-direction:column;align-items:stretch;}
    #overlayUI{position:fixed;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;gap:12px;z-index:50}
    .card{backdrop-filter:blur(6px);background:rgba(255,255,255,0.04);padding:8px;border-radius:999px;display:flex;gap:8px;align-items:center;}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:white;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    button.primary{background:linear-gradient(90deg,#4dd0e1,#7bdff0);color:#052026;border:0}
    #hint{position:fixed;left:12px;bottom:16px;right:12px;color:#9aa6b2;font-size:13px;text-align:center;z-index:40}
    #message{position:fixed;left:50%;transform:translateX(-50%);top:60px;background:rgba(0,0,0,0.5);padding:8px 12px;border-radius:10px;color:white;z-index:60}
    canvas{touch-action:auto;display:block;}
  </style>
</head>
<body>
<div id="app">
  <div id="overlayUI">
    <div class="card">
      <div style="font-weight:700">AR Multi Markers</div>
    </div>
    <div class="card" id="controls">
      <button id="btnStart" class="primary">start ar</button>
      <button id="btnReset">reset</button>
    </div>
  </div>
  <div id="message" style="display:none"></div>
  <div id="container"></div>
  <div id="hint">tap on surface to add marker — tap marker to remove</div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';

const btnStart = document.getElementById('btnStart');
const btnReset = document.getElementById('btnReset');
const message = document.getElementById('message');
const container = document.getElementById('container');

let camera, scene, renderer, reticle, clock = new THREE.Clock();
let markers = []; // all active markers
const colors = [0x4dd0e1, 0x7b61ff, 0xff7ab6, 0x6ee07a];

function showMsg(text, timeout = 2500){
  message.style.display='block';
  message.textContent=text;
  clearTimeout(message._t);
  message._t=setTimeout(()=> message.style.display='none', timeout);
}

// initialize three.js renderer and scene
function initThree(){
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.xr.enabled = true;
  container.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);

  const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
  scene.add(light);

  const ringGeo = new THREE.RingGeometry(0.07,0.09,32);
  const ringMat = new THREE.MeshBasicMaterial({color:0xffffff,side:THREE.DoubleSide,transparent:true,opacity:0.85});
  reticle = new THREE.Mesh(ringGeo,ringMat);
  reticle.rotation.x = -Math.PI/2;
  reticle.visible = false;
  scene.add(reticle);

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

// create a marker group (sphere + halo + label)
function createMarker(text, colorIndex=0){
  const group = new THREE.Group();

  // sphere
  const sphereGeo = new THREE.SphereGeometry(0.1, 32, 24);
  const sphereMat = new THREE.MeshStandardMaterial({
    metalness:0.3, roughness:0.2,
    emissive:colors[colorIndex],
    emissiveIntensity:0.5
  });
  const sphere = new THREE.Mesh(sphereGeo, sphereMat);
  sphere.name = 'sphere';
  group.add(sphere);

  // halo
  const torusGeo = new THREE.TorusGeometry(0.15, 0.015, 16, 100);
  const torusMat = new THREE.MeshBasicMaterial({color:colors[colorIndex], transparent:true, opacity:0.8});
  const halo = new THREE.Mesh(torusGeo, torusMat);
  halo.rotation.x = Math.PI/2;
  halo.position.y = -0.02;
  halo.name = 'halo';
  group.add(halo);

  // label
  const canvas = document.createElement('canvas');
  canvas.width=512; canvas.height=128;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle='rgba(5,32,38,0.9)';
  ctx.fillRect(0,0,512,128);
  ctx.font='bold 46px system-ui';
  ctx.fillStyle='white';
  ctx.textAlign='center';
  ctx.fillText(text, 256, 80);
  const texture = new THREE.CanvasTexture(canvas);
  const labelMat = new THREE.MeshBasicMaterial({map:texture, transparent:false});
  const labelGeo = new THREE.PlaneGeometry(0.6,0.15);
  const labelMesh = new THREE.Mesh(labelGeo, labelMat);
  labelMesh.position.y = 0.25;
  labelMesh.name = 'label';
  group.add(labelMesh);

  // add click detection
  group.userData.isMarker = true;
  return group;
}

// handle marker placement
function placeMarkerAt(pos, quat){
  const labelText = prompt("برچسب مارکر را وارد کنید:", "مارکر جدید") || "مارکر جدید";
  const colorIndex = Math.floor(Math.random()*colors.length);
  const marker = createMarker(labelText, colorIndex);
  marker.position.copy(pos);
  if(quat) marker.quaternion.copy(quat);
  scene.add(marker);
  markers.push(marker);
  showMsg('marker added');
}

// handle tap on marker or ground
function onSelect(event){
  // raycast to check if marker was tapped
  const raycaster = new THREE.Raycaster();
  const tempMatrix = new THREE.Matrix4();
  tempMatrix.identity().extractRotation(event.target.matrixWorld);
  raycaster.ray.origin.setFromMatrixPosition(event.target.matrixWorld);
  raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix);
  const intersects = raycaster.intersectObjects(markers, true);

  if(intersects.length>0){
    // remove tapped marker
    const m = intersects[0].object.parent;
    scene.remove(m);
    markers = markers.filter(x=>x!==m);
    showMsg('marker removed');
    return;
  }

  // if no marker hit, place a new one
  if(reticle && reticle.visible){
    const pos = new THREE.Vector3();
    pos.setFromMatrixPosition(reticle.matrix);
    const quat = new THREE.Quaternion();
    quat.setFromRotationMatrix(reticle.matrix);
    placeMarkerAt(pos, quat);
  }
}

// animate markers
function animateMarkers(delta){
  for(const m of markers){
    const halo = m.getObjectByName('halo');
    if(halo) halo.rotation.z += delta * 0.6;
    const sphere = m.getObjectByName('sphere');
    if(sphere){
      const t = performance.now()*0.001;
      sphere.material.emissiveIntensity = 0.3 + Math.abs(Math.sin(t*2))*0.5;
    }
    const label = m.getObjectByName('label');
    if(label) label.lookAt(renderer.xr.isPresenting?renderer.xr.getCamera(camera).position:camera.position);
  }
}

// start ar session
async function startARSession(){
  if(!renderer) initThree();
  const arButton = ARButton.createButton(renderer, { requiredFeatures:['hit-test'] });
  arButton.style.display='none';
  document.body.appendChild(arButton);

  const sessionPromise = new Promise((resolve)=>{
    renderer.xr.addEventListener('sessionstart', ()=>resolve(true));
    renderer.xr.addEventListener('sessionend', ()=>resolve(false));
    arButton.click();
  });
  const started = await sessionPromise;
  if(!started){ showMsg('xr session not started'); return; }

  renderer.setAnimationLoop(render);
  const session = renderer.xr.getSession();
  const viewerSpace = await session.requestReferenceSpace('viewer');
  const hitTestSource = await session.requestHitTestSource({space:viewerSpace});
  session._hitTestSource = hitTestSource;

  const controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);
}

// render loop
function render(timestamp, frame){
  const delta = clock.getDelta();
  if(frame){
    const session = renderer.xr.getSession();
    if(session && session._hitTestSource){
      const hitTestResults = frame.getHitTestResults(session._hitTestSource);
      if(hitTestResults.length>0){
        const hit = hitTestResults[0];
        const pose = hit.getPose(renderer.xr.getReferenceSpace());
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);
        reticle.matrix.decompose(reticle.position, reticle.quaternion, reticle.scale);
      } else reticle.visible = false;
    }
  }
  animateMarkers(delta);
  renderer.render(scene, camera);
}

btnStart.addEventListener('click', ()=> startARSession());
btnReset.addEventListener('click', ()=>{
  for(const m of markers) scene.remove(m);
  markers=[];
  showMsg('all markers removed');
});

initThree();
showMsg('ready — tap start ar');
</script>
</body>
</html>
